# AKS Workshop

[![GitHub Pages](https://img.shields.io/badge/docs-GitHub%20Pages-blue)](https://dotnetpower.github.io/aks-workshop/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Kubernetes](https://img.shields.io/badge/Kubernetes-1.30-326CE5?logo=kubernetes&logoColor=white)](https://kubernetes.io/)
[![Azure](https://img.shields.io/badge/Azure-AKS-0078D4?logo=microsoft-azure&logoColor=white)](https://azure.microsoft.com/ko-kr/services/kubernetes-service/)
[![Istio](https://img.shields.io/badge/Istio-1.24-466BB0?logo=istio&logoColor=white)](https://istio.io/)
[![Docusaurus](https://img.shields.io/badge/Docusaurus-3.9.2-3ECC5F?logo=docusaurus&logoColor=white)](https://docusaurus.io/)

AKSì— Istio Service Meshë¥¼ êµ¬ì„±í•˜ê³  Kubernetes ì‹¤ìŠµì„ í¬í•¨í•˜ëŠ” ì›Œí¬ìƒµì…ë‹ˆë‹¤.

## ğŸ“š ë¬¸ì„œ ì‚¬ì´íŠ¸

ì›Œí¬ìƒµ ë¬¸ì„œëŠ” [GitHub Pages](https://dotnetpower.github.io/aks-workshop/)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ğŸš€ ì›Œí¬ìƒµ ì£¼ì œ

### Kubernetes ê¸°ì´ˆ
* Deployment, Service, ConfigMap, Secret
* Blue-Green ë°°í¬ ë° Canary ë°°í¬

### ê³ ê¸‰ Kubernetes
* Volumesì™€ ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬
* Ingress Controller
* Health Probes
* Init Container ë° Multi-Container Pods
* Jobsì™€ CronJobs

### Pod ìŠ¤ì¼€ì¤„ë§
* Node Affinityì™€ Anti-Affinity
* Taintì™€ Toleration
* Topology Spread Constraints
* StatefulSet

### ì˜¤í† ìŠ¤ì¼€ì¼ë§
* Resource Requests/Limits
* Horizontal Pod Autoscaler (HPA)
* KEDA (Event-driven Autoscaling)
  * RabbitMQ ê¸°ë°˜ ìŠ¤ì¼€ì¼ë§
  * Cron ê¸°ë°˜ ìŠ¤ì¼€ì¼ë§

### Service Mesh (Istio)
* Traffic Management (Request Routing, Traffic Shifting)
* Fault Injection
* Circuit Breaking
* Authorization
* Observability (Prometheus, Grafana, Jaeger, Kiali)

## ğŸ“– ë¹ ë¥¸ ì‹œì‘

### 1. ì‚¬ì „ ì¤€ë¹„

```bash
# Azure CLI ì„¤ì¹˜
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

# kubectl ì„¤ì¹˜
sudo az aks install-cli

# Helm ì„¤ì¹˜
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
```

### 2. í´ëŸ¬ìŠ¤í„° ìƒì„±

```bash
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
source ./env.sh

# ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ìƒì„±
az group create --location $LOCATION --resource-group $RESOURCE_GROUP

# AKS í´ëŸ¬ìŠ¤í„° ìƒì„± (ì•½ 5-10ë¶„ ì†Œìš”)
az aks create \
  --resource-group $RESOURCE_GROUP \
  --name $CLUSTER \
  --location $LOCATION \
  --node-count $NODE_COUNT \
  --kubernetes-version $K8S_VERSION \
  --network-plugin azure \
  --generate-ssh-keys

# í´ëŸ¬ìŠ¤í„° ìê²© ì¦ëª… ê°€ì ¸ì˜¤ê¸°
az aks get-credentials --resource-group $RESOURCE_GROUP --name $CLUSTER --overwrite-existing
```

### 3. ì‹¤ìŠµ ì‹œì‘

[ì›Œí¬ìƒµ ë¬¸ì„œ](https://dotnetpower.github.io/aks-workshop/)ë¥¼ ë”°ë¼ ì‹¤ìŠµì„ ì§„í–‰í•˜ì„¸ìš”.

## ğŸ§ª í…ŒìŠ¤íŠ¸

ìƒì„¸í•œ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œëŠ” [TEST_GUIDE.md](./TEST_GUIDE.md)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

### ì „ì²´ ì‹¤ìŠµ í…ŒìŠ¤íŠ¸

```bash
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
source ./env.sh

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥)
./test-workshop.sh 2>&1 | tee test-results.log
```

### í…ŒìŠ¤íŠ¸ ë²”ìœ„

- âœ… Module 1: Kubernetes ê¸°ì´ˆ (Deployment, Service, ConfigMap, Secret)
- âœ… Module 3: ê³ ê¸‰ Kubernetes (Volumes, Probes)
- âœ… Module 6: Pod ìŠ¤ì¼€ì¤„ë§ (NodeSelector, Affinity)
- âœ… Module 7: ì˜¤í† ìŠ¤ì¼€ì¼ë§ (Resource Limits, HPA)

### ë¦¬ì†ŒìŠ¤ ì •ë¦¬

```bash
# í…ŒìŠ¤íŠ¸ ë¦¬ì†ŒìŠ¤ë§Œ ì •ë¦¬
./cleanup-workshop.sh --test

# Bookinfo ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ë¦¬
./cleanup-workshop.sh --bookinfo

# Istio ë¦¬ì†ŒìŠ¤ ì •ë¦¬
./cleanup-workshop.sh --istio

# ëª¨ë“  ë¦¬ì†ŒìŠ¤ ì •ë¦¬
./cleanup-workshop.sh --all

# í´ëŸ¬ìŠ¤í„° ì™„ì „ ì‚­ì œ
./cleanup-workshop.sh --delete-cluster
```

## ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
.
â”œâ”€â”€ docs/                           # Docusaurus ë¬¸ì„œ
â”‚   â”œâ”€â”€ docs/
â”‚   â”‚   â”œâ”€â”€ setup/                  # í™˜ê²½ ì„¤ì •
â”‚   â”‚   â”œâ”€â”€ kubernetes-basics/       # Kubernetes ê¸°ì´ˆ
â”‚   â”‚   â”œâ”€â”€ advanced-kubernetes/     # ê³ ê¸‰ Kubernetes
â”‚   â”‚   â”œâ”€â”€ scheduling/              # Pod ìŠ¤ì¼€ì¤„ë§
â”‚   â”‚   â”œâ”€â”€ autoscaling/             # ì˜¤í† ìŠ¤ì¼€ì¼ë§
â”‚   â”‚   â”œâ”€â”€ monitoring/              # ëª¨ë‹ˆí„°ë§
â”‚   â”‚   â”œâ”€â”€ hands-on-labs/           # Istio ì‹¤ìŠµ
â”‚   â”‚   â””â”€â”€ advanced/                # ê³ ê¸‰ íŒ
â”‚   â””â”€â”€ static/                      # ì´ë¯¸ì§€ ë° ì •ì  íŒŒì¼
â”œâ”€â”€ protected/                       # ì°¸ê³  ìŠ¤í¬ë¦½íŠ¸
â”‚   â”œâ”€â”€ Module_1/                    # Kubernetes ê¸°ì´ˆ ìŠ¤í¬ë¦½íŠ¸
â”‚   â”œâ”€â”€ Module_3/                    # ê³ ê¸‰ Kubernetes ìŠ¤í¬ë¦½íŠ¸
â”‚   â”œâ”€â”€ Module_6/                    # ìŠ¤ì¼€ì¤„ë§ ìŠ¤í¬ë¦½íŠ¸
â”‚   â””â”€â”€ Module_7/                    # ì˜¤í† ìŠ¤ì¼€ì¼ë§ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ images/                          # ë¬¸ì„œ ì´ë¯¸ì§€
â”œâ”€â”€ test-workshop.sh                 # í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ cleanup-workshop.sh              # ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸
â””â”€â”€ istio-env.sh                     # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
```

## ğŸ› ï¸ ë¡œì»¬ì—ì„œ ë¬¸ì„œ ì‹¤í–‰

```bash
cd docs
npm install
npm start
```

ë¸Œë¼ìš°ì €ì—ì„œ `http://localhost:3000/aks-workshop/`ë¡œ ì ‘ì†í•©ë‹ˆë‹¤.

## ğŸ“ ë¬¸ì„œ ë¹Œë“œ

```bash
cd docs
npm run build
npm run serve
```

## ğŸ¤ ê¸°ì—¬

ì´ìŠˆë‚˜ PRì€ ì–¸ì œë‚˜ í™˜ì˜í•©ë‹ˆë‹¤!

### ë¬¸ì„œ ì‘ì„± ê°€ì´ë“œë¼ì¸

* ê° ë¬¸ì„œëŠ” í•œêµ­ì–´ë¡œ ì‘ì„±í•©ë‹ˆë‹¤
* ì‹¤ìŠµ ì˜ˆì œì™€ YAML íŒŒì¼ì„ í¬í•¨í•©ë‹ˆë‹¤
* ë‹¨ê³„ë³„ ëª…ë ¹ì–´ì™€ ì˜ˆìƒ ê²°ê³¼ë¥¼ ì œê³µí•©ë‹ˆë‹¤
* ì‹¤ìŠµ ê³¼ì œ ì„¹ì…˜ì„ ì¶”ê°€í•©ë‹ˆë‹¤

## ğŸ“„ ë¼ì´ì„ ìŠ¤

MIT License

## ğŸ“ ë¬¸ì˜

ë¬¸ì œê°€ ë°œìƒí•˜ë©´ [GitHub Issues](https://github.com/dotnetpower/aks-workshop/issues)ì— ë“±ë¡í•´ì£¼ì„¸ìš”.

## ì›Œí¬ìƒµ ì£¼ì œ
* ì¿ ë²„ë„¤í‹°ìŠ¤
  * ë°°ê²½
  * ë¬¸ì œ
  * ë¬¸ì œ ì™„í™” ë°©ì•ˆ
* ì„œë¹„ìŠ¤ ë©”ì‰¬
  * Istio ì•„í‚¤í…ì²˜ ë° ì»´í¬ë„ŒíŠ¸
* Hands-on Labs
  * Traffic Management
  * Observility


## Hands-on Lab 
### ì‚¬ì „ í•„ìš” í™˜ê²½
<details>
  <summary> Ubuntu ê¸°ì¤€ í™˜ê²½ ì„¤ì • ë°©ë²•</summary>
  
  ```bash
  # Azure CLI ì„¤ì¹˜
  curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

  # AKS CLI ì„¤ì¹˜
  sudo az aks install-cli

  # Helm ì„¤ì¹˜
  curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

  # vscode ì„¤ì¹˜(WSL ì´ë‚˜ ë¡œì»¬ í™˜ê²½ì¸ ê²½ìš°)
  sudo apt-get install wget gpgwget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpgsudo install -D -o root -g root -m 644 packages.microsoft.gpg /etc/apt/keyrings/packages.microsoft.gpgsudo sh -c 'echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list'rm -f packages.microsoft.gpg

  sudo apt install apt-transport-https
  sudo apt update
  sudo apt install code

  # SSH Server ì„¤ì¹˜(ìœˆë„ìš° ì‚¬ìš©ìê°€ vscode remote ë¥¼ ì´ìš©í•´ì„œ ì‘ì—…í•˜ê¸°ìœ„í•œ í™˜ê²½)
  sudo apt-get install openssh-server
  sudo apt-get install sshfs

  ```
  window cmd ì—ì„œ
  ```cmd
  ssh-keygen -t rsa -b 4096 -f %userprofile%\.ssh\linux_rsa
  scp %userprofile%\.ssh\linux_rsa.pub -i <pem_file_path> dotnetpower@<remote_ip>:~/

  [powershell]
  ssh-keygen -m PEM -t rsa -b 2048
  ```
  ubuntu ì—ì„œ
  ```bash
  sudo cat linux_rsa.pub >> ~/.ssh/authorized_keys
  sudo nano /etc/ssh/sshd_config
  # sshd_config íŒŒì¼ ì¤‘ AllowTcpForwarding yes ì£¼ì„ í•´ì œ
  sudo systemctl restart sshd
  ```

  ì ‘ì† í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ window cmd ì—ì„œ
  ```cmd
  ssh -i %userprofile%/.ssh/linux_rsa user_id@<remote_ip>
  ```

  vscode ì˜ remote explorer extension ì„¤ì¹˜ í•˜ì—¬ ë¦¬ëª¨íŠ¸ ì„œë²„ ì ‘ì†

  **!ì£¼ì˜: Azure VM ì˜ ê²½ìš° SSH port open ì‹œê°„ì´ ì§§ì•„ì„œ JIT open ì„ ì£¼ê¸°ì ìœ¼ë¡œ í•´ì•¼ í•¨.**

</details>

### í´ëŸ¬ìŠ¤í„° êµ¬ì„±

istio-env.sh
```
# í™˜ê²½ë³€ìˆ˜
seq=1
# export CLUSTER=istio-addon-lab-${seq}
# export RESOURCE_GROUP=istio-addon-lab-rg-${seq}
# export LOCATION=eastus #koreacentral
# export K8S_VERSION=1.27.7

export CLUSTER=istio-addon-lab
export RESOURCE_GROUP=gmarket-istio-lab
export LOCATION=koreacentral
export K8S_VERSION=1.27.7

```


```
# í™˜ê²½ë³€ìˆ˜ ì„¤ì •
source ./istio-env.sh
```

aks-preview ì„¤ì • ë° AzureServiceMeshPreview í™œì„±í™” (mesh íƒ€ì…ì„ osm ì´ë‚˜ istio ë¡œ ì§€ì • í•„ìš”)
```bash
# aks-preview ì„¤ì¹˜
az extension add --name aks-preview
az extension update --name aks-preview

# AzureServiceMeshPreview ë“±ë¡
az feature register --namespace "Microsoft.ContainerService" --name "AzureServiceMeshPreview"
az feature show --namespace "Microsoft.ContainerService" --name "AzureServiceMeshPreview"

# ì»¨í…Œì´ë„ˆ ì„œë¹„ìŠ¤ ë“±ë¡(ê¶Œí•œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ” ê²½ìš° ê¶Œí•œ ìˆëŠ” ì‚¬ìš©ìê°€ ì‹¤í–‰ í•„ìš”)
az provider register --namespace Microsoft.ContainerService



# ë¦¬ì†ŒìŠ¤ ê·¸ë£¹ ìƒì„±[5secs]
az group create --location $LOCATION --resource-group $RESOURCE_GROUP

# í´ëŸ¬ìŠ¤í„° ìƒì„±[6mins]
az aks create \
--resource-group $RESOURCE_GROUP \
--name $CLUSTER \
--enable-asm \
--network-plugin azure \
--node-count 3 \
--kubernetes-version $K8S_VERSION \
--generate-ssh-keys

# (optional)ì´ë¯¸ ìƒì„±ëœ í´ëŸ¬ìŠ¤í„°ê°€ ìˆëŠ” ê²½ìš° mesh í™œì„±í™”ë¥¼ ìœ„í•´ ë‹¤ìŒ ëª…ë ¹
# az aks mesh enable -g $RESOURCE_GROUP -n $CLUSTER 

az aks get-credentials --resource-group $RESOURCE_GROUP --name $CLUSTER


```

ì •ìƒ ì„¤ì • ì—¬ë¶€ í™•ì¸
```bash
# ë‹¤ìŒ ëª…ë ¹ì–´ ì‹¤í–‰ í›„ "Istio" ê°€ ì •ìƒì ìœ¼ë¡œ ë‚˜ì˜¤ëŠ”ì§€ í™•ì¸
az aks show --resource-group $RESOURCE_GROUP --name $CLUSTER  --query 'serviceMeshProfile.mode'

# aks-istio-system ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ëŒ€í•œ íŒŒë“œ í™•ì¸
kubectl get pods -n aks-istio-system


```

Envoy proxy ì‚¬ìš© ì „ ë¦¬ì†ŒìŠ¤ í˜„í™©
```bash
kubectl top node --use-protocol-buffers
```

sidecar ì£¼ì… í™œì„±í™”(bookinfo)
```bash
kubectl create ns bookinfo
kubectl label namespace bookinfo istio.io/rev=asm-1-18

```

Envoy proxy ì‚¬ìš© ì„¤ì • í›„ ë¦¬ì†ŒìŠ¤(20~30% ì •ë„ ì‚¬ìš©ë¥  ì¦ê°€)
```bash
kubectl top node --use-protocol-buffers
```


**istioctl ì„¤ì¹˜**
istio ë²„ì „ì´ ë°”ë€” ìˆ˜ ìˆìœ¼ë¯€ë¡œ í™•ì¸ í•„ìš”
```bash
# ë²„ì „ í™•ì¸
ISTIO_VERSION="$(kubectl get deploy istiod-asm-1-18 -n aks-istio-system -o yaml | grep image: | egrep -o '[0-9]+\.[0-9]+\.[0-9]+')"

# ì„¤ì •ëœ ë²„ì „ í™•ì¸
echo $ISTIO_VERSION

# cli ì„¤ì¹˜
curl -L https://istio.io/downloadIstio | ISTIO_VERSION=$ISTIO_VERSION TARGET_ARCH=x86_64 sh -
sudo cp  "istio-${ISTIO_VERSION}/bin/istioctl" /usr/local/bin
rm -rf "./istio-${ISTIO_VERSION}/"

# istio ë²„ì „ í™•ì¸
istioctl -i aks-istio-system version

```
> client version: 1.18.7 \
control plane version: 1.18-dev \
data plane version: none

**data plane ì´ none ìœ¼ë¡œ ë³´ì—¬ì§€ëŠ” ì´ìœ ëŠ” ë°°í¬ëœ in/egress traffic, envoy proxy ê°€ ì—†ê¸° ë•Œë¬¸**


ì™¸ë¶€ ingress ê²Œì´íŠ¸ì›¨ì´ í™œì„±í™”[4ë¶„ê°€ëŸ‰ ì†Œìš”]
```bash
az aks mesh enable-ingress-gateway --resource-group $RESOURCE_GROUP --name $CLUSTER --ingress-gateway-type external

# public ip, port í™•ì¸
kubectl get svc aks-istio-ingressgateway-external -n aks-istio-ingress

# istiod ë²„ì „ í™•ì¸
kubectl get deploy -n aks-istio-system


ISTIOD_NAME=$(kubectl get deploy -n aks-istio-system | awk 'NR>1 {print $1}')

# istiod dash ì„¤ì¹˜/ì‹¤í–‰(ë²„ì „ì´ 1.18ì¸ ê²½ìš°)
istioctl dashboard controlz deployment/$ISTIOD_NAME -n aks-istio-system

```

![Alt text](./images/image.png)

Bookinfo ìƒ˜í”Œ ì•± ë°°í¬
```bash
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/platform/kube/bookinfo.yaml -n bookinfo

```
<details>
  <summary>bookinfo.yaml</summary>

```
# Copyright Istio Authors
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.

##################################################################################################
# This file defines the services, service accounts, and deployments for the Bookinfo sample.
#
# To apply all 4 Bookinfo services, their corresponding service accounts, and deployments:
#
#   kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
#
# Alternatively, you can deploy any resource separately:
#
#   kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml -l service=reviews # reviews Service
#   kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml -l account=reviews # reviews ServiceAccount
#   kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml -l app=reviews,version=v3 # reviews-v3 Deployment
##################################################################################################

##################################################################################################
# Details service
##################################################################################################
apiVersion: v1
kind: Service
metadata:
  name: details
  labels:
    app: details
    service: details
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: details
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bookinfo-details
  labels:
    account: details
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: details-v1
  labels:
    app: details
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: details
      version: v1
  template:
    metadata:
      labels:
        app: details
        version: v1
    spec:
      serviceAccountName: bookinfo-details
      containers:
      - name: details
        image: docker.io/istio/examples-bookinfo-details-v1:1.16.2
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9080
---
##################################################################################################
# Ratings service
##################################################################################################
apiVersion: v1
kind: Service
metadata:
  name: ratings
  labels:
    app: ratings
    service: ratings
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: ratings
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bookinfo-ratings
  labels:
    account: ratings
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ratings-v1
  labels:
    app: ratings
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ratings
      version: v1
  template:
    metadata:
      labels:
        app: ratings
        version: v1
    spec:
      serviceAccountName: bookinfo-ratings
      containers:
      - name: ratings
        image: docker.io/istio/examples-bookinfo-ratings-v1:1.16.2
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9080
---
##################################################################################################
# Reviews service
##################################################################################################
apiVersion: v1
kind: Service
metadata:
  name: reviews
  labels:
    app: reviews
    service: reviews
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: reviews
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bookinfo-reviews
  labels:
    account: reviews
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v1
  labels:
    app: reviews
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v1
  template:
    metadata:
      labels:
        app: reviews
        version: v1
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v1:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v2
  labels:
    app: reviews
    version: v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v2
  template:
    metadata:
      labels:
        app: reviews
        version: v2
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v2:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: reviews-v3
  labels:
    app: reviews
    version: v3
spec:
  replicas: 1
  selector:
    matchLabels:
      app: reviews
      version: v3
  template:
    metadata:
      labels:
        app: reviews
        version: v3
    spec:
      serviceAccountName: bookinfo-reviews
      containers:
      - name: reviews
        image: docker.io/istio/examples-bookinfo-reviews-v3:1.16.2
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_DIR
          value: "/tmp/logs"
        ports:
        - containerPort: 9080
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: wlp-output
          mountPath: /opt/ibm/wlp/output
      volumes:
      - name: wlp-output
        emptyDir: {}
      - name: tmp
        emptyDir: {}
---
##################################################################################################
# Productpage services
##################################################################################################
apiVersion: v1
kind: Service
metadata:
  name: productpage
  labels:
    app: productpage
    service: productpage
spec:
  ports:
  - port: 9080
    name: http
  selector:
    app: productpage
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: bookinfo-productpage
  labels:
    account: productpage
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: productpage-v1
  labels:
    app: productpage
    version: v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: productpage
      version: v1
  template:
    metadata:
      labels:
        app: productpage
        version: v1
    spec:
      serviceAccountName: bookinfo-productpage
      containers:
      - name: productpage
        image: docker.io/istio/examples-bookinfo-productpage-v1:1.16.2
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 9080
        volumeMounts:
        - name: tmp
          mountPath: /tmp
      volumes:
      - name: tmp
        emptyDir: {}
---
```
</details>

ì„œë¹„ìŠ¤ ìƒì„± í™•ì¸
```bash
kubectl get services -n bookinfo

```

íŒŒë“œ í™•ì¸
```bash
kubectl get pods -n bookinfo
```

DestinationRule ì„¤ì •
```bash
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/destination-rule-all.yaml -n bookinfo

# destinationrule í™•ì¸
kubectl get destinationrules -n bookinfo

# kubectl get destinationrule details -n bookinfo -o yaml
```

<details>
  <summary>destination-rule-all.yaml</summary>

```
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: productpage
spec:
  host: productpage
  subsets:
  - name: v1
    labels:
      version: v1
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: reviews
spec:
  host: reviews
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
  - name: v3
    labels:
      version: v3
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: ratings
spec:
  host: ratings
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
  - name: v2-mysql
    labels:
      version: v2-mysql
  - name: v2-mysql-vm
    labels:
      version: v2-mysql-vm
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: details
spec:
  host: details
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---
```
</details>

ë‚´ë¶€ì—ì„œ ratings ë¡œ ì ‘ì† í…ŒìŠ¤íŠ¸
```bash
kubectl exec "$(kubectl get pod -l app=ratings -o jsonpath='{.items[0].metadata.name}' -n bookinfo)" -n bookinfo -c ratings -- curl -sS productpage:9080/productpage | grep -o "<title>.*</title>"

```
> `<title>Simple Bookstore App</title>`

ì•„ì§ ì™¸ë¶€ì—ì„œ ì ‘ì†ì´ ì•ˆë˜ë¯€ë¡œ ì™¸ë¶€ì—ì„œ ì ‘ì† í—ˆìš©ì„ ìœ„í•œ external ingress gateway ì ìš©
```bash
kubectl apply -n bookinfo -f - <<EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: bookinfo-gateway-external
spec:
  selector:
    istio: aks-istio-ingressgateway-external
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo-vs-external
spec:
  hosts:
  - "*"
  gateways:
  - bookinfo-gateway-external
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage
        port:
          number: 9080
EOF
```
ìƒì„± í™•ì¸
```bash
kubectl get gateway -n bookinfo
kubectl get virtualservices -n bookinfo

```

ì™¸ë¶€ IP ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´
```bash
export INGRESS_HOST_EXTERNAL=$(kubectl -n aks-istio-ingress get service aks-istio-ingressgateway-external -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
export INGRESS_PORT_EXTERNAL=$(kubectl -n aks-istio-ingress get service aks-istio-ingressgateway-external -o jsonpath='{.spec.ports[?(@.name=="http2")].port}')
export GATEWAY_URL_EXTERNAL=$INGRESS_HOST_EXTERNAL:$INGRESS_PORT_EXTERNAL

# url í™•ì¸
echo "http://$GATEWAY_URL_EXTERNAL/productpage"
```

ì ‘ì† í…ŒìŠ¤íŠ¸
```bash
curl -s "http://${GATEWAY_URL_EXTERNAL}/productpage" | grep -o "<title>.*</title>"

```
> `<title>Simple Bookstore App</title>`

í™•ì¸ëœ URL ë¡œ ì ‘ì† ì‹œ - http://$GATEWAY_URL_EXTERNAL/productpage
![Alt text](./images/image-bookinfo.png)

ì „ë°˜ì ì¸ êµ¬ì¡° í™•ì¸ with ClusterInfo

**êµ¬ì¡°ë§Œ í™•ì¸**
```bash
# install clusterinfo with helm
helm repo add scubakiz https://scubakiz.github.io/clusterinfo/
helm repo update
helm install clusterinfo scubakiz/clusterinfo

# forward port to local
kubectl port-forward svc/clusterinfo 5252:5252 -n clusterinfo
```

## ëª¨ë‹ˆí„° ë„êµ¬

Prometheus, Grafana, Jaeger, Kiali ì„¤ì¹˜
```bash
# Prometheus - metrics
curl -s https://raw.githubusercontent.com/istio/istio/release-1.18/samples/addons/prometheus.yaml | sed 's/istio-system/aks-istio-system/g' | kubectl apply -f -

# Grafana - monitoring and metrics dashboards
curl -s https://raw.githubusercontent.com/istio/istio/release-1.18/samples/addons/grafana.yaml | sed 's/istio-system/aks-istio-system/g' | kubectl apply -f -

# Jaeger - distributed tracing
curl -s https://raw.githubusercontent.com/istio/istio/release-1.18/samples/addons/jaeger.yaml | sed 's/istio-system/aks-istio-system/g' | kubectl apply -f -

# Kiali installation
helm install \
    --version=1.76.0 \
    --set cr.create=true \
    --set cr.namespace=aks-istio-system \
    --namespace aks-istio-system \
    --create-namespace \
    kiali-operator \
    kiali/kiali-operator


```

Kiali í† í° ìƒì„± ë° í¬ì›Œí¬ì›Œë”©
```bash
# Kiali ì— ì ‘ì†í•˜ê¸° ìœ„í•œ í† í° ìƒì„±(kiali ìƒì„± í›„ ê³§ë°”ë¡œ ì‹¤í–‰ ì‹œ ì‹¤íŒ¨í•  ìˆ˜ ìˆìœ¼ë‹ˆ ì‹œê°„ì„ ë‘ê³  ì‹¤í–‰)
kubectl -n aks-istio-system create token kiali-service-account

TODO: kiali ë²„ì „ ì¬ í™•ì¸ í•„ìš”. https://github.com/istio/istio/blob/release-1.8/samples/addons/kiali.yaml ì—ì„œ ì¶”ê°€ spec ì •ë¦¬ í•„ìš”.
# http://localhost:20001 ìœ¼ë¡œ ì ‘ì† í• ìˆ˜ ìˆë„ë¡ í¬íŠ¸í¬ì›Œë”©
kubectl port-forward svc/kiali 20001:20001 -n aks-istio-system &
```

(optional) vscode remote í™˜ê²½ì´ë¼ë©´ í•˜ë‹¨ Ports íƒ­ì—ì„œ 20001 í¬íŠ¸ ì¶”ê°€ í›„ http://localhost:20001 ë¡œ ì ‘ì† ê°€ëŠ¥
![Alt text](./images/image-kiali.png)


íŠ¸ë˜í”½ì„ ë°œìƒì‹œì¼œ Kiali UI ì—ì„œ í™•ì¸
```bash
# 100ë²ˆ ìš”ì²­
for i in $(seq 1 100); do curl -o /dev/null -s -w "Request: ${i}, Response: %{http_code}\n" "http://$GATEWAY_URL_EXTERNAL/productpage"; done

# ë¬´í•œ ìš”ì²­
let i=0; while :; do let i++; curl -o /dev/null -s -w "Request: ${i}, Response: %{http_code}\n" "http://$GATEWAY_URL_EXTERNAL/productpage"; done
```
Kiali ì˜ Graph ë©”ë‰´
![Alt text](./images/image-kiali-graph.png)
![Alt text](./images/image-kiali-graph2.png)


## Prometheus í¬íŠ¸í¬ì›Œë”© ë° ì ‘ì† í™•ì¸ (background ì‹¤í–‰)
```bash
kubectl port-forward -n aks-istio-system svc/prometheus 9090:9090 &
```
![Alt text](./images/image-prometheus.png)

ëª‡ê°€ì§€ ì¿¼ë¦¬ - https://istio.io/latest/docs/tasks/observability/metrics/querying-metrics/
* productpage ì„œë¹„ìŠ¤ì— ìš”ì²­ ìˆ˜
  ```
  istio_requests_total{destination_service="productpage.bookinfo.svc.cluster.local"}
  ```
* reviews ì„œë¹„ìŠ¤ì˜ v3ì— ìš”ì²­ ìˆ˜
  ```
  istio_requests_total{destination_service="reviews.bookinfo.svc.cluster.local", destination_version="v3"}
  ```
* ë§ˆì§€ë§‰ 5ë¶„ë™ì•ˆ productpage ì˜ ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ì— ëŒ€í•œ ìš”ì²­
  ```x
  rate(istio_requests_total{destination_service=~"productpage.*", response_code="200"}[5m])
  ```

## Grafana í¬íŠ¸í¬ì›Œë”© ë° ì ‘ì† í™•ì¸ (background ì‹¤í–‰)
```bash
kubectl port-forward -n aks-istio-system svc/grafana 3000:3000 &
```
Dashboard -> Browse -> istio
![Alt text](./images/image-grafana.png)

## Jaeger UI í¬íŠ¸í¬ì›Œë”© ë° ì ‘ì† í™•ì¸ (background ì‹¤í–‰)
```bash
kubectl port-forward -n aks-istio-system $JAEGER_POD 16686:16686 &
```
![Alt text](./images/image-jaeger.png)

DAG(Directed Acyclic Graph) í™•ì¸
1. Search ë©”ë‰´
2. Service ì— productpage.bookinfo ì„ íƒ
3. Lookback ì— ì ì ˆí•œ ì‹œê°„ ì„ íƒ í›„ Find Traces
4. ê²°ê³¼ í•˜ë‚˜ë¥¼ í´ë¦­
5. System Architecture ë©”ë‰´
6. DAG í´ë¦­

![Alt text](./images/image-jaeger-dag.png)

## ëª¨ë‹ˆí„°ë§ w/ managed
ì°¸ê³ : [Prometheus ë° Grafana ì‚¬ìš©](https://learn.microsoft.com/ko-kr/azure/azure-monitor/containers/kubernetes-monitoring-enable?tabs=cli#enable-prometheus-and-grafana)

ëª…ë ¹ì–´ ë³´ë‹¤ëŠ” Azure Portal ì—ì„œ í´ë¦­í•˜ëŠ”ê²Œ í¸í•¨.
**ì¶”ê°€ í…ŒìŠ¤íŠ¸ í•„ìš”!!**
```
# ê¸°ë³¸ Azure Monitor workspace ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •
az aks update --enable-azure-monitor-metrics -n $CLUSTER -g $RESOURCE_GROUP

### Use existing Azure Monitor workspace
az aks create/update --enable-azure-monitor-metrics -n <cluster-name> -g <cluster-resource-group> --azure-monitor-workspace-resource-id <workspace-name-resource-id>

### Use an existing Azure Monitor workspace and link with an existing Grafana workspace
az aks create/update --enable-azure-monitor-metrics -n <cluster-name> -g <cluster-resource-group> --azure-monitor-workspace-resource-id <azure-monitor-workspace-name-resource-id> --grafana-resource-id  <grafana-workspace-name-resource-id>

### Use optional parameters
az aks create/update --enable-azure-monitor-metrics -n <cluster-name> -g <cluster-resource-group> --ksm-metric-labels-allow-list "namespaces=[k8s-label-1,k8s-label-n]" --ksm-metric-annotations-allow-list "pods=[k8s-annotation-1,k8s-annotation-n]"
```

# istio ì‹¤ìŠµ
## Request Routing
> [!Note]
> http://$GATEWAY_URL_EXTERNAL/productpage ì— ì ‘ì†í•˜ì—¬ ìƒˆë¡œê³ ì¹¨ì„ í•˜ì—¬ reviews ì˜ ë²„ì „ì´ ë°”ë€ŒëŠ” ê²ƒì„ í™•ì¸
> 1. v1 ì ìš© í›„ ìƒˆë¡œê³ ì¹¨ í•´ì„œ v1 ìœ¼ë¡œ ê³ ì •ì´ ë˜ëŠ”ì§€ í™•ì¸
> 2. ì‚¬ìš©ì ê³„ì •ì€ jason/jason ì´ë¯€ë¡œ ë¡œê·¸ì¸ í›„ v1 ìœ¼ë¡œ ìœ ì§€ ë˜ëŠ”ì§€ í™•ì¸
> 3. v2 ì ìš© í›„ ìƒˆë¡œê³ ì¹¨, ë¡œê·¸ì•„ì›ƒ í›„ ì˜ˆìƒê³¼ ê°™ì´ ë™ì‘ í•˜ëŠ”ì§€ í™•ì¸
> (optional) Kaili ì—ì„œ ìš”ì²­ì´ v1 ìœ¼ë¡œë§Œ ê°€ëŠ”ì§€ í™•ì¸
```bash
# ëª¨ë“  ìš”ì²­ì„ reviews:v1 ìœ¼ë¡œë§Œ ë³´ë‚´ê¸°
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-all-v1.yaml -n bookinfo

# jason ë§Œ reviews:v2 ë¡œ ë³´ë‚´ê¸°
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml -n bookinfo
```


<details>
  <summary>virtual-service-all-v1.yaml</summary>
  ```
  apiVersion: networking.istio.io/v1alpha3
  kind: VirtualService
  metadata:
    name: productpage
  spec:
    hosts:
    - productpage
    http:
    - route:
      - destination:
          host: productpage
          subset: v1
  ---
  apiVersion: networking.istio.io/v1alpha3
  kind: VirtualService
  metadata:
    name: reviews
  spec:
    hosts:
    - reviews
    http:
    - route:
      - destination:
          host: reviews
          subset: v1
  ---
  apiVersion: networking.istio.io/v1alpha3
  kind: VirtualService
  metadata:
    name: ratings
  spec:
    hosts:
    - ratings
    http:
    - route:
      - destination:
          host: ratings
          subset: v1
  ---
  apiVersion: networking.istio.io/v1alpha3
  kind: VirtualService
  metadata:
    name: details
  spec:
    hosts:
    - details
    http:
    - route:
      - destination:
          host: details
          subset: v1
  ---
  ```
</details>

<details>
  <summary>virtual-service-reviews-test-v2.yaml</summary>
```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
    - reviews
  http:
  - match:
    - headers:
        end-user:
          exact: jason
    route:
    - destination:
        host: reviews
        subset: v2
  - route:
    - destination:
        host: reviews
        subset: v1
```
</details>

ref: https://github.com/istio/istio/tree/master/samples/bookinfo/networking
## Request Routing - ë¦¬ì†ŒìŠ¤ ì •ë¦¬
```bash
kubectl delete -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml -n bookinfo
kubectl delete -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-all-v1.yaml -n bookinfo
```

## Traffic Shifting
> [!Note]
> reviews ë²„ì „ì— ë”°ë¼ íŠ¸ë˜í”½ ì§€ì •
> CI/CD pipeline êµ¬ì„± ì‹œ canary ë°°í¬ ì ìš© ë°©ì•ˆ ê³ ë¯¼
```bash
# v1ì™€ v3ì— ê°ê° íŠ¸ë˜í”½ 50% ì”© ë¶„ë°°
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml -n bookinfo

# v2ì™€ v3ì— ê°ê° íŠ¸ë˜í”½ 50% ì”© ë¶„ë°°
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-reviews-v2-v3.yaml -n bookinfo

# v3 ì— íŠ¸ë˜í”½ 100%
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-reviews-v3.yaml -n bookinfo
```


<details>
  <summary>virtual-service-reviews-50-v3.yaml</summary>
```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
    - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v1
      weight: 50
    - destination:
        host: reviews
        subset: v3
      weight: 50
```
</details>


<details>
  <summary>virtual-service-reviews-v3.yaml</summary>
```
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews
spec:
  hosts:
    - reviews
  http:
  - route:
    - destination:
        host: reviews
        subset: v3
```
</details>

## Traffic Shifting - ë¦¬ì†ŒìŠ¤ ì •ë¦¬
```bash
kubectl delete -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-reviews-v3.yaml -n bookinfo
kubectl delete -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-reviews-v2-v3.yaml -n bookinfo
kubectl delete -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml -n bookinfo
```

## Fault Injection
íŠ¹ì • ì„œë¹„ìŠ¤ì— ì˜ˆìƒì¹˜ ëª»í•œ ë¬¸ì œê°€ ë°œìƒë  ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ Fault ì£¼ì…ì„ í†µí•´ ì„œë¹„ìŠ¤(ì–´í”Œë¦¬ì¼€ì´ì…˜)ê°€ ì–´ë–»ê²Œ ëŒ€ì‘í•˜ëŠ”ì§€ í™•ì¸ í•˜ê¸° ìœ„í•¨.
ì½”ë“œë³€ê²½ì´ ì•„ë‹Œ Fault Injection ì •ì˜ë¡œ Resilience test ê°€ëŠ¥
> [!Note]
> productpage
```bash
# ëª¨ë“  ìš”ì²­ì„ v1 ìœ¼ë¡œë§Œ íë¥´ê²Œ ì„¤ì •
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-all-v1.yaml -n bookinfo

# jason ì‚¬ìš©ìë§Œ reviews:v2 ë¡œ ì„¤ì •
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml -n bookinfo
```
## Fault Injection - ë¦¬ì†ŒìŠ¤ ì •ë¦¬
```bash
kubectl delete -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml -n bookinfo
kubectl delete -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-all-v1.yaml -n bookinfo
```

TODO: ì½”ë“œ

### HTTP delay fault ì£¼ì…
> [!Note]
> Action Item: 7ì´ˆ ë”œë ˆì´ê°€ ì•„ë‹Œ 2ì´ˆ ë”œë ˆì´ë¥¼ ì£¼ë©´ ì–´ë–»ê²Œ ë˜ëŠ”ì§€ í™•ì¸ í•´ë³´ì.
<!-- $${\color{white}kubectl apply -n bookinfo -f - <<EOF ...}$$ -->
```bash
# jason ì—ê²Œë§Œ 7ì´ˆ ë”œë ˆì´ê°€ ë°œìƒë˜ê²Œ ì„¤ì •
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml -n bookinfo
```
Hint!
https://github.com/istio/istio/blob/ea97d32cf46200d20378647d521001530f005bc8/samples/bookinfo/src/productpage/productpage.py#L400

### HTTP delay fault ì£¼ì… - ë¦¬ì†ŒìŠ¤ ì •ë¦¬
```bash
kubectl delete -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml -n bookinfo

```


### HTTP abort fault ì£¼ì…
ratings ì´ ì˜¤ë¥˜ê°€ ë°œìƒë˜ì—ˆë‹¤ëŠ” ìƒí™©ì„ ë§Œë“¤ì–´ ë³µì›ë ¥ í™•ì¸ ê°€ëŠ¥
> [!Note]
> http://$GATEWAY_URL_EXTERNAL/productpage ì— ì ‘ì†í•˜ì—¬ ìƒˆë¡œê³ ì¹¨ í• ë•Œ v1ìœ¼ë¡œ ê³ ì •ë˜ëŠ”ì§€ í™•ì¸
> jason ì‚¬ìš©ìì—ê²Œ ì ìš©ë˜ëŠ” ê·œì¹™ì´ ì •ìƒì ìœ¼ë¡œ ì ìš©ë˜ëŠ”ì§€ í™•ì¸
> ì„¸ë²ˆì§¸ ê·œì¹™ì´ jason ì—ê²Œë§Œ ë°œìƒë˜ê³  ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì—ê²ŒëŠ” ì •ìƒì ìœ¼ë¡œ v1 ìœ¼ë¡œ ì—°ê²° ë˜ëŠ”ì§€ í™•ì¸

```bash
# ëª¨ë“  ìš”ì²­ì„ v1 ìœ¼ë¡œ 
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-all-v1.yaml -n bookinfo

# jason ì‚¬ìš©ìë§Œ v2ë¡œ, ë‚˜ë¨¸ì§„ v1ìœ¼ë¡œ
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml -n bookinfo

# v1ì— 500 ì—ëŸ¬ ë°œìƒì‹œí‚¤ê³  jason ì‚¬ìš©ìë§Œ v1 ìœ¼ë¡œ
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml -n bookinfo
```
ë‹¤ìŒ ì½”ë“œë¡œ ì„œë¹„ìŠ¤ ìš”ì²­ì„ í•˜ëŠ” ë™ì•ˆ kiali ì—ì„œ ì‹¤íŒ¨ìš”ì²­ì´ íŠ¸ë˜í‚¹ ë˜ëŠ”ì§€ í™•ì¸
```bash
for i in $(seq 1 100); do curl -o /dev/null -s -w "Request: ${i}, Response: %{http_code}\n" "http://$GATEWAY_URL_EXTERNAL/productpage"; done

# ë¬´í•œ ìš”ì²­
let i=0; while :; do let i++; curl -o /dev/null -s -w "Request: ${i}, Response: %{http_code}\n" "http://$GATEWAY_URL_EXTERNAL/productpage"; done

# ë˜ëŠ” 
watch -n 1 curl -o /dev/null -s -w %{http_code} $GATEWAY_URL_EXTERNAL/productpage
```
### HTTP abort fault ì£¼ì… - ë¦¬ì†ŒìŠ¤ ì •ë¦¬
```bash
kubectl delete -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml -n bookinfo
kubectl delete -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml -n bookinfo
kubectl delete -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/bookinfo/networking/virtual-service-all-v1.yaml -n bookinfo

```


### Circuit Breaking
https://istio.io/latest/docs/tasks/traffic-management/circuit-breaking/

httpbin êµ¬ì„±

```bash
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/httpbin/httpbin.yaml -n bookinfo
```

```bash
kubectl apply -n bookinfo -f - <<EOF
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: httpbin
spec:
  host: httpbin
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 1
      http:
        http1MaxPendingRequests: 1
        maxRequestsPerConnection: 1
    outlierDetection:
      consecutive5xxErrors: 1
      interval: 1s
      baseEjectionTime: 3m
      maxEjectionPercent: 100
EOF
```

í™•ì¸
```bash
kubectl get destinationrule httpbin -n bookinfo -o yaml
```

fortio(ë¶€í•˜í…ŒìŠ¤íŠ¸ ë„êµ¬) êµ¬ì„±

```bash
kubectl apply -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/httpbin/sample-client/fortio-deploy.yaml -n bookinfo

export FORTIO_POD=$(kubectl get pods -l app=fortio -n bookinfo -o jsonpath='{.items[0].metadata.name}')
kubectl exec $FORTIO_POD -c fortio -n bookinfo -- /usr/bin/fortio curl -quiet http://httpbin:8000/get
```

2ê°œì˜ ì»¤ë„¥ì…˜ìœ¼ë¡œ 20ë²ˆì˜ ìš”ì²­
```bash
kubectl exec $FORTIO_POD -c fortio -n bookinfo -- /usr/bin/fortio load -c 2 -qps 0 -n 20 -loglevel Warning http://httpbin:8000/get
```
maxRequestsPerConnection ê°€ 1ë¡œ ì„¤ì •ì´ ë˜ì–´ ë™ì‹œ ìš”ì²­ 2ê°œì¸ ê²½ìš° 1ê°œëŠ” circuit breaking ê±¸ë¦¼.


### Circuit Breaking - ë¦¬ì†ŒìŠ¤ ì •ë¦¬
ê·œì¹™ ì‚­ì œ
```bash
kubectl delete destinationrule httpbin -n bookinfo

```

httpbin ì„œë¹„ìŠ¤ì™€ í´ë¼ì´ì–¸íŠ¸ ì œê±°
```bash
kubectl delete -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/httpbin/sample-client/fortio-deploy.yaml -n bookinfo
kubectl delete -f https://raw.githubusercontent.com/istio/istio/release-1.18/samples/httpbin/httpbin.yaml -n bookinfo
```

## Security - Authorization - HTTP Traffic
HTTP íŠ¸ë˜í”½ì— ëŒ€í•´ ALLOW ì•¡ì…˜ ì •ì±… ì„¤ì •ìœ¼ë¡œ ì ‘ì† í—ˆìš©/ê±°ë¶€ ì ìš©
https://istio.io/latest/docs/tasks/security/authorization/authz-http/
```bash
# ëª¨ë“  ìš”ì²­ ì°¨ë‹¨
kubectl apply -f - <<EOF
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-nothing
  namespace: bookinfo
spec:
  {}
EOF
```
http://$GATEWAY_URL_EXTERNAL/productpage í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ë©´ RBAC: access denied ë°œìƒ

```bash
# productpageë§Œ í—ˆìš©, details, reviews, rating ì€ ì—¬ì „íˆ ì°¨ë‹¨
kubectl apply -f - <<EOF
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: "productpage-viewer"
  namespace: bookinfo
spec:
  selector:
    matchLabels:
      app: productpage
  action: ALLOW
  rules:
  - to:
    - operation:
        methods: ["GET"]
EOF
```
![Alt text](./images/image-authorization-productpage.png)

```bash
# details ë„ í—ˆìš©
kubectl apply -f - <<EOF
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: "details-viewer"
  namespace: bookinfo
spec:
  selector:
    matchLabels:
      app: details
  action: ALLOW
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/bookinfo/sa/bookinfo-productpage"]
    to:
    - operation:
        methods: ["GET"]
EOF

# reviews ë„ í—ˆìš©
kubectl apply -f - <<EOF
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: "reviews-viewer"
  namespace: bookinfo
spec:
  selector:
    matchLabels:
      app: reviews
  action: ALLOW
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/bookinfo/sa/bookinfo-productpage"]
    to:
    - operation:
        methods: ["GET"]
EOF


# ratings ë„ í—ˆìš©
kubectl apply -f - <<EOF
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: "ratings-viewer"
  namespace: bookinfo
spec:
  selector:
    matchLabels:
      app: ratings
  action: ALLOW
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/bookinfo/sa/bookinfo-reviews"]
    to:
    - operation:
        methods: ["GET"]
EOF
```
![Alt text](./images/image-authorization-end.png)


## IBM Robot-shop

ì˜¤ë¥˜ ë°œìƒêµ¬ê°„ì„ Kiali ë¡œ í™•ì¸
> [!Note]
> ì™œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ”ì§€ ì›ì¸ ì°¾ê¸°

```bash
# ë‹¤ë¥¸ í´ë”ë¡œ ì´ë™ í›„
git clone https://github.com/instana/robot-shop
kubectl create ns robot-shop

# ì‚¬ì´ë“œì¹´ ì¸ì ì…˜
kubectl label namespace robot-shop istio.io/rev=asm-1-18

# helm ìœ¼ë¡œ robot-shop ì„¤ì¹˜
helm install robot-shop --namespace robot-shop .

# ë°°í¬ìƒíƒœ í™•ì¸
kubectl get pod,svc -n robot-shop



WEB_SVC_EXTERNAL_IP=$(kubectl get svc -n robot-shop | grep ^web | awk '{print $4}')
WEB_SVC_EXTERNAL_PORT=$(kubectl get svc -n robot-shop | grep ^web | awk '{print $5}' | cut -d ':' -f 1)
ROBOT_SHOP_URL="http://${WEB_SVC_EXTERNAL_IP}:${WEB_SVC_EXTERNAL_PORT}"
echo $ROBOT_SHOP_URL


```

```bash
kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: robotshop-gateway
  namespace: robot-shop
spec:
  selector:
    istio: aks-istio-ingressgateway-external
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "*"
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: robotshop
  namespace: robot-shop
spec:
  hosts:
  - "*"
  gateways:
  - robotshop-gateway
  http:
  # default route
  - route:
    - destination:
        host: web.robot-shop.svc.cluster.local
        port:
          number: 8080
EOF

```






# ë¦¬ì†ŒìŠ¤ ì •ë¦¬ - ì „ì²´
```bash
az aks mesh disable --resource-group ${RESOURCE_GROUP} --name ${CLUSTER}
kubectl delete crd $(kubectl get crd -A | grep "istio.io" | awk '{print $1}')

az group delete --name ${RESOURCE_GROUP} --yes --no-wait
```




## ìƒì„¸ ì •ë³´
mesh ì˜ proxy ì •ë³´
```bash
istioctl -i aks-istio-system proxy-status
```
```bash
NAME                                                                              CLUSTER        CDS        LDS        EDS        RDS        ECDS         ISTIOD                               VERSION
aks-istio-ingressgateway-external-asm-1-18-7466f77bb9-2bx8x.aks-istio-ingress     Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED     NOT SENT     istiod-asm-1-18-746d8f469c-mttxb     1.18.7-distroless
aks-istio-ingressgateway-external-asm-1-18-7466f77bb9-zwjnz.aks-istio-ingress     Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED     NOT SENT     istiod-asm-1-18-746d8f469c-bvl92     1.18.7-distroless
details-v1-7c7dbcb4b5-prwmr.bookinfo                                              Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED     NOT SENT     istiod-asm-1-18-746d8f469c-bvl92     1.18.7-distroless
productpage-v1-664d44d68d-hx9dw.bookinfo                                          Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED     NOT SENT     istiod-asm-1-18-746d8f469c-bvl92     1.18.7-distroless
ratings-v1-844796bf85-dzjnc.bookinfo                                              Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED     NOT SENT     istiod-asm-1-18-746d8f469c-mttxb     1.18.7-distroless
reviews-v1-5cf854487-6dqfz.bookinfo                                               Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED     NOT SENT     istiod-asm-1-18-746d8f469c-mttxb     1.18.7-distroless
reviews-v2-955b74755-492qp.bookinfo                                               Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED     NOT SENT     istiod-asm-1-18-746d8f469c-bvl92     1.18.7-distroless
reviews-v3-797fc48bc9-rqvk8.bookinfo                                              Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED     NOT SENT     istiod-asm-1-18-746d8f469c-bvl92     1.18.7-distroless
```

productpage ì˜ ì‚¬ì´ë“œì¹´ ì¸ì ì…˜ ì •ë³´
```bash
PRODUCTPAGE_POD=$(kubectl get pods -n bookinfo | grep ^productpage | awk '{print $1}')
istioctl -i aks-istio-system experimental check-inject $PRODUCTPAGE_POD -n bookinfo
```
Mesh êµ¬ì„±ì •ë³´ ìƒì„¸
```bash
istioctl -i aks-istio-system experimental describe pod $PRODUCTPAGE_POD -n bookinfo
```

productpageì˜ envoy ì— ëŒ€í•´ì„œ
```bash
istioctl -i aks-istio-system proxy-config endpoint $PRODUCTPAGE_POD -n bookinfo
```





---



vscode remote ports
![Alt text](./images/image-vscode-ports.png)

```
# bash ì»¤ë§¨ë“œ ì°½ì— ì‹œê°„ ì°ê¸°
sudo timedatectl set-timezone Asia/Seoul
export PROMPT_COMMAND="echo -n \[\$(date +%H:%M:%S)\]\ "

# í˜„ì¬ í´ëŸ¬ìŠ¤í„°ë¥¼ ì»¤ë§¨íŠ¸ ì°½ ì•ì— ë¶™ì´ê¸°
export PROMPT_COMMAND="echo -n [$CLUSTER]"
```



